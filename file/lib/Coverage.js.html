<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/Coverage.js | chrome-remote-interface-extra</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Like jprichardson/fs-extra but for the chrome-remote-interface-extra by cyrus-and"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="chrome-remote-interface-extra"><meta property="twitter:description" content="Like jprichardson/fs-extra but for the chrome-remote-interface-extra by cyrus-and"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/N0taN3rd/chrome-remote-interface-extra"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/LifecycleWatcher.js~LifecycleWatcher.html">LifecycleWatcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Target.js~Target.html">Target</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CRIExtra">CRIExtra</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CoverageEntry">CoverageEntry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Device">Device</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DeviceDescriptorViewPort">DeviceDescriptorViewPort</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DOMRGBA">DOMRGBA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-KeyDescription">KeyDescription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BoxModel">BoxModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ConsoleMessage.Location">ConsoleMessage.Location</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ExtraDomainsConfig">ExtraDomainsConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Metrics">Metrics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PDFOptions">PDFOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PageInitOptions">PageInitOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ScreenshotOptions">ScreenshotOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Viewport">Viewport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-KeyDefinition">KeyDefinition</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#accessibility">accessibility</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/accessibility/AXNode.js~AXNode.html">AXNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/accessibility/Accessibility.js~Accessibility.html">Accessibility</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AXNode">AXNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Accessibility">Accessibility</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SerializedAXNode">SerializedAXNode</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#browser">browser</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/browser/Browser.js~Browser.html">Browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/browser/BrowserContext.js~BrowserContext.html">BrowserContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Browser">Browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BrowserContext">BrowserContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BrowserInitOptions">BrowserInitOptions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#frames">frames</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/frames/Frame.js~Frame.html">Frame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/frames/FrameManager.js~FrameManager.html">FrameManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/frames/FrameResource.js~FrameResource.html">FrameResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/frames/FrameResourceTree.js~FrameResourceTree.html">FrameResourceTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Frame">Frame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FrameManager">FrameManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FrameResource">FrameResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FrameResourceTree">FrameResourceTree</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#network">network</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/Cookie.js~Cookie.html">Cookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/NetworkIdleWatcher.js~NetIdleWatcher.html">NetIdleWatcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/NetworkManager.js~NetworkManager.html">NetworkManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/Request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/Response.js~Response.html">Response</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/network/SecurityDetails.js~SecurityDetails.html">SecurityDetails</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-H2Method">H2Method</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Cookie">Cookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NetIdleWatcher">NetIdleWatcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NetworkManager">NetworkManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Request">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Response">Response</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SecurityDetails">SecurityDetails</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CDPCookie">CDPCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NetIdleOptions">NetIdleOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CookieParam">CookieParam</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CookieToBeDeleted">CookieToBeDeleted</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ModifyCookieParam">ModifyCookieParam</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NetworkConditions">NetworkConditions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-UserAgentOverride">UserAgentOverride</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/Coverage.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const { helper, debugError, assert } = require(&apos;./helper&apos;)
const { EVALUATION_SCRIPT_URL } = require(&apos;./ExecutionContext&apos;)

/**
 * @typedef {Object} CoverageEntry
 * @property {string} url
 * @property {string} text
 * @property {Array&lt;!{start: number, end: number}&gt;} ranges
 */

class Coverage {
  /**
   * @param {Chrome|CRIConnection|CDPSession|Object} client
   */
  constructor (client) {
    this._jsCoverage = new JSCoverage(client)
    this._cssCoverage = new CSSCoverage(client)
  }

  /**
   * @param {!{resetOnNavigation?: boolean, reportAnonymousScripts?: boolean}} options
   */
  startJSCoverage (options) {
    return this._jsCoverage.start(options)
  }

  /**
   * @return {Promise&lt;Array&lt;!CoverageEntry&gt;&gt;}
   */
  stopJSCoverage () {
    return this._jsCoverage.stop()
  }

  /**
   * @param {{resetOnNavigation?: boolean}=} options
   */
  startCSSCoverage (options) {
    return this._cssCoverage.start(options)
  }

  /**
   * @return {Promise&lt;Array&lt;!CoverageEntry&gt;&gt;}
   */
  stopCSSCoverage () {
    return this._cssCoverage.stop()
  }
}

class JSCoverage {
  /**
   * @param {Chrome|CRIConnection|CDPSession|Object} client
   */
  constructor (client) {
    this._client = client
    this._enabled = false
    this._scriptURLs = new Map()
    this._scriptSources = new Map()
    this._eventListeners = []
    this._resetOnNavigation = false
  }

  /**
   * @param {!{resetOnNavigation?: boolean, reportAnonymousScripts?: boolean}} options
   */
  async start (options = {}) {
    assert(!this._enabled, &apos;JSCoverage is already enabled&apos;)
    const { resetOnNavigation = true, reportAnonymousScripts = false } = options
    this._resetOnNavigation = resetOnNavigation
    this._reportAnonymousScripts = reportAnonymousScripts
    this._enabled = true
    this._scriptURLs.clear()
    this._scriptSources.clear()
    this._eventListeners = [
      helper.addEventListener(
        this._client,
        &apos;Debugger.scriptParsed&apos;,
        this._onScriptParsed.bind(this)
      ),
      helper.addEventListener(
        this._client,
        &apos;Runtime.executionContextsCleared&apos;,
        this._onExecutionContextsCleared.bind(this)
      )
    ]
    await Promise.all([
      this._client.send(&apos;Profiler.enable&apos;),
      this._client.send(&apos;Profiler.startPreciseCoverage&apos;, {
        callCount: false,
        detailed: true
      }),
      this._client.send(&apos;Debugger.enable&apos;),
      this._client.send(&apos;Debugger.setSkipAllPauses&apos;, { skip: true })
    ])
  }

  _onExecutionContextsCleared () {
    if (!this._resetOnNavigation) return
    this._scriptURLs.clear()
    this._scriptSources.clear()
  }

  /**
   * @param {!Object} event
   */
  async _onScriptParsed (event) {
    // Ignore puppeteer-injected scripts
    if (event.url === EVALUATION_SCRIPT_URL) return
    // Ignore other anonymous scripts unless the reportAnonymousScripts option is true.
    if (!event.url &amp;&amp; !this._reportAnonymousScripts) return
    try {
      const response = await this._client.send(&apos;Debugger.getScriptSource&apos;, {
        scriptId: event.scriptId
      })
      this._scriptURLs.set(event.scriptId, event.url)
      this._scriptSources.set(event.scriptId, response.scriptSource)
    } catch (e) {
      // This might happen if the page has already navigated away.
      debugError(e)
    }
  }

  /**
   * @return {Promise&lt;Array&lt;!CoverageEntry&gt;&gt;}
   */
  async stop () {
    assert(this._enabled, &apos;JSCoverage is not enabled&apos;)
    this._enabled = false
    const [profileResponse] = await Promise.all([
      this._client.send(&apos;Profiler.takePreciseCoverage&apos;),
      this._client.send(&apos;Profiler.stopPreciseCoverage&apos;),
      this._client.send(&apos;Profiler.disable&apos;),
      this._client.send(&apos;Debugger.disable&apos;)
    ])
    helper.removeEventListeners(this._eventListeners)

    const coverage = []
    for (const entry of profileResponse.result) {
      let url = this._scriptURLs.get(entry.scriptId)
      if (!url &amp;&amp; this._reportAnonymousScripts) {
        url = &apos;debugger://VM&apos; + entry.scriptId
      }
      const text = this._scriptSources.get(entry.scriptId)
      if (text === undefined || url === undefined) continue
      const flattenRanges = []
      for (const func of entry.functions) flattenRanges.push(...func.ranges)
      const ranges = convertToDisjointRanges(flattenRanges)
      coverage.push({ url, ranges, text })
    }
    return coverage
  }
}

class CSSCoverage {
  /**
   * @param {!Chrome|CRIConnection|CDPSession|Object} client
   */
  constructor (client) {
    this._client = client
    this._enabled = false
    this._stylesheetURLs = new Map()
    this._stylesheetSources = new Map()
    this._eventListeners = []
    this._resetOnNavigation = false
  }

  /**
   * @param {{resetOnNavigation?: boolean}=} options
   */
  async start (options = {}) {
    assert(!this._enabled, &apos;CSSCoverage is already enabled&apos;)
    const { resetOnNavigation = true } = options
    this._resetOnNavigation = resetOnNavigation
    this._enabled = true
    this._stylesheetURLs.clear()
    this._stylesheetSources.clear()
    this._eventListeners = [
      helper.addEventListener(
        this._client,
        &apos;CSS.styleSheetAdded&apos;,
        this._onStyleSheet.bind(this)
      ),
      helper.addEventListener(
        this._client,
        &apos;Runtime.executionContextsCleared&apos;,
        this._onExecutionContextsCleared.bind(this)
      )
    ]
    await Promise.all([
      this._client.send(&apos;DOM.enable&apos;),
      this._client.send(&apos;CSS.enable&apos;),
      this._client.send(&apos;CSS.startRuleUsageTracking&apos;)
    ])
  }

  _onExecutionContextsCleared () {
    if (!this._resetOnNavigation) return
    this._stylesheetURLs.clear()
    this._stylesheetSources.clear()
  }

  /**
   * @param {!Object} event
   */
  async _onStyleSheet (event) {
    const header = event.header
    // Ignore anonymous scripts
    if (!header.sourceURL) return
    try {
      const response = await this._client.send(&apos;CSS.getStyleSheetText&apos;, {
        styleSheetId: header.styleSheetId
      })
      this._stylesheetURLs.set(header.styleSheetId, header.sourceURL)
      this._stylesheetSources.set(header.styleSheetId, response.text)
    } catch (e) {
      // This might happen if the page has already navigated away.
      debugError(e)
    }
  }

  /**
   * @return {Promise&lt;Array&lt;!CoverageEntry&gt;&gt;}
   */
  async stop () {
    assert(this._enabled, &apos;CSSCoverage is not enabled&apos;)
    this._enabled = false
    const ruleTrackingResponse = await this._client.send(
      &apos;CSS.stopRuleUsageTracking&apos;
    )
    await Promise.all([
      this._client.send(&apos;CSS.disable&apos;),
      this._client.send(&apos;DOM.disable&apos;)
    ])
    helper.removeEventListeners(this._eventListeners)

    // aggregate by styleSheetId
    const styleSheetIdToCoverage = new Map()
    for (const entry of ruleTrackingResponse.ruleUsage) {
      let ranges = styleSheetIdToCoverage.get(entry.styleSheetId)
      if (!ranges) {
        ranges = []
        styleSheetIdToCoverage.set(entry.styleSheetId, ranges)
      }
      ranges.push({
        startOffset: entry.startOffset,
        endOffset: entry.endOffset,
        count: entry.used ? 1 : 0
      })
    }

    const coverage = []
    for (const styleSheetId of this._stylesheetURLs.keys()) {
      const url = this._stylesheetURLs.get(styleSheetId)
      const text = this._stylesheetSources.get(styleSheetId)
      const ranges = convertToDisjointRanges(
        styleSheetIdToCoverage.get(styleSheetId) || []
      )
      coverage.push({ url, ranges, text })
    }

    return coverage
  }
}

/**
 * @param {Array&lt;!{startOffset:number, endOffset:number, count:number}&gt;} nestedRanges
 * @return {Array&lt;!{start:number, end:number}&gt;}
 */
function convertToDisjointRanges (nestedRanges) {
  const points = []
  for (const range of nestedRanges) {
    points.push({ offset: range.startOffset, type: 0, range })
    points.push({ offset: range.endOffset, type: 1, range })
  }
  // Sort points to form a valid parenthesis sequence.
  points.sort((a, b) =&gt; {
    // Sort with increasing offsets.
    if (a.offset !== b.offset) return a.offset - b.offset
    // All &quot;end&quot; points should go before &quot;start&quot; points.
    if (a.type !== b.type) return b.type - a.type
    const aLength = a.range.endOffset - a.range.startOffset
    const bLength = b.range.endOffset - b.range.startOffset
    // For two &quot;start&quot; points, the one with longer range goes first.
    if (a.type === 0) return bLength - aLength
    // For two &quot;end&quot; points, the one with shorter range goes first.
    return aLength - bLength
  })

  const hitCountStack = []
  const results = []
  let lastOffset = 0
  // Run scanning line to intersect all ranges.
  for (const point of points) {
    if (
      hitCountStack.length &amp;&amp;
      lastOffset &lt; point.offset &amp;&amp;
      hitCountStack[hitCountStack.length - 1] &gt; 0
    ) {
      const lastResult = results.length ? results[results.length - 1] : null
      if (lastResult &amp;&amp; lastResult.end === lastOffset) {
        lastResult.end = point.offset
      } else {
        results.push({ start: lastOffset, end: point.offset })
      }
    }
    lastOffset = point.offset
    if (point.type === 0) hitCountStack.push(point.range.count)
    else hitCountStack.pop()
  }
  // Filter out empty ranges.
  return results.filter(range =&gt; range.end - range.start &gt; 1)
}

/**
 * @type {{CSSCoverage: CSSCoverage, Coverage: Coverage, JSCoverage: JSCoverage}}
 */
module.exports = { Coverage, JSCoverage, CSSCoverage }
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
